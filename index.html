<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Yêu em</title>

  <style>
    :root{
      --bg:#070914;
      --panel: rgba(10,12,25,0.62);
      --line: rgba(255,255,255,0.12);
      --text: rgba(245,247,255,0.92);
      --muted: rgba(245,247,255,0.70);
      --accent: #ffdf9e;
      --accent2:#a6c8ff;
      --shadow: 0 18px 70px rgba(0,0,0,0.45);
      --r: 18px;
      --max: 1100px;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; margin:0; background:var(--bg); color:var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    #app{ position:fixed; inset:0; overflow:hidden; }
    canvas{ display:block; width:100%; height:100%; }

    /* NAV */
    .nav{
      position:fixed;
      top:14px; left:50%; transform:translateX(-50%);
      width:min(var(--max), calc(100% - 24px));
      z-index:30;
      display:flex; align-items:center; justify-content:space-between;
      gap:12px;
      padding:10px 12px;
      border-radius: 16px;
      background: var(--panel);
      border:1px solid var(--line);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
    }
    .brand{ display:flex; align-items:center; gap:10px; min-width: 180px; }
    .logo{
      width:34px; height:34px; border-radius:12px;
      background: radial-gradient(circle at 30% 30%, rgba(255,223,158,.95), rgba(166,200,255,.25));
      border:1px solid rgba(255,255,255,.16);
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }
    .brand b{ font-size:14px; letter-spacing:.2px; display:block; line-height:1.1; }
    .brand span{ font-size:12px; color:rgba(245,247,255,.55); }

    .links{ display:flex; gap:8px; flex-wrap:wrap; justify-content:center; }
    .links a{
      text-decoration:none;
      color: var(--muted);
      font-size:13px;
      padding:8px 10px;
      border-radius: 12px;
      border:1px solid transparent;
      transition:.18s ease;
    }
    .links a:hover{ color:var(--text); background:rgba(255,255,255,.06); border-color:rgba(255,255,255,.14); }
    .links a.active{
      color:#101425;
      background: linear-gradient(135deg, rgba(255,223,158,.95), rgba(166,200,255,.95));
      border-color:rgba(255,255,255,.20);
    }

    .right{ display:flex; gap:10px; align-items:center; justify-content:flex-end; min-width: 180px; }
    .btn{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding:8px 10px;
      border-radius: 12px;
      cursor:pointer;
      font-size: 13px;
      transition:.18s ease;
      user-select:none;
    }
    .btn:hover{ background: rgba(255,255,255,.09); }
    .btnPrimary{
      border-color: rgba(255,223,158,.28);
      background: rgba(255,223,158,.10);
    }
    .btnPrimary:hover{ background: rgba(255,223,158,.14); }
    .btn:disabled{ opacity:.55; cursor:not-allowed; }

    /* CONTROL PANEL */
    .panel{
      position:fixed;
      left:14px; bottom:14px;
      width:min(420px, calc(100% - 28px));
      z-index:25;
      background: var(--panel);
      border:1px solid var(--line);
      border-radius: var(--r);
      padding:12px 12px 10px;
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
    }
    .panel h3{ margin:0 0 8px; font-size:14px; letter-spacing:.2px; }
    .hint{ font-size:12.5px; line-height:1.55; color:rgba(245,247,255,.72); }
    .row{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    .tog{ display:flex; align-items:center; gap:8px; margin-top:10px; font-size:12.5px; color:rgba(245,247,255,.75); user-select:none; }
    .mono{ margin-top:10px; font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size:12px; color:rgba(245,247,255,.72); }

    /* OVERLAYS (Letter / Photos) */
    .overlay{
      position:fixed; inset:0;
      z-index:40;
      display:none;
      align-items:center; justify-content:center;
      padding:18px;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(2px);
    }
    .overlay.on{ display:flex; }
    .card{
      width:min(980px, 100%);
      border-radius: 22px;
      overflow:hidden;
      background: rgba(14,16,30,.92);
      border:1px solid rgba(255,255,255,.12);
      box-shadow: 0 30px 120px rgba(0,0,0,.55);
      position:relative;
    }
    .cardHead{
      display:flex; align-items:center; justify-content:space-between;
      padding:14px 14px 10px;
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .cardHead b{ font-size:14px; letter-spacing:.2px; }
    .xbtn{
      width:38px; height:38px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      color: var(--text);
      cursor:pointer;
    }
    .cardBody{ padding:14px; }

    .letter{
      background: rgba(255,255,255,.05);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 18px;
      padding: 14px;
      line-height: 1.75;
      font-size: 14.5px;
      color: rgba(245,247,255,.90);
    }
    .letter b{ color: rgba(255,223,158,.95); }
    .sig{ margin-top:12px; color:rgba(245,247,255,.70); font-size:13px; }

    .gallery{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap:12px;
    }
    .shot{
      grid-column: span 4;
      border-radius: 18px;
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      cursor:pointer;
      transition: transform .18s ease, border-color .18s ease;
    }
    .shot:hover{ transform: translateY(-2px); border-color: rgba(255,223,158,.22); }
    .shot img{ width:100%; height: 280px; object-fit: cover; display:block; filter: brightness(1.06) contrast(1.05); }
    @media (max-width: 980px){ .shot{ grid-column: span 6; } }
    @media (max-width: 560px){ .shot{ grid-column: span 12; } }

    /* IMAGE LIGHTBOX */
    .lightboxImg{
      width:100%;
      height:min(78vh, 760px);
      object-fit: contain;
      background: rgba(0,0,0,.25);
      display:block;
    }

    /* SMALL NOTE (top-right) */
    .toast{
      position:fixed;
      right:14px; bottom:14px;
      z-index:26;
      background: rgba(10,12,25,0.60);
      border:1px solid rgba(255,255,255,0.12);
      border-radius: 14px;
      padding: 10px 12px;
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
      max-width: 320px;
      color: rgba(245,247,255,.78);
      font-size: 12.5px;
      line-height: 1.45;
      display:none;
    }
    .toast.on{ display:block; }

  </style>

  <script type="importmap">
    {
      "imports": {
        "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
        "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
      }
    }
  </script>
</head>

<body>
  <div id="app"></div>

  <!-- NAV -->
  <header class="nav">
    <div class="brand">
      <div class="logo"></div>
      <div>
        <b>Yêu em</b>
        <span>web động — người xem tự điều khiển</span>
      </div>
    </div>

    <nav class="links" id="links">
      <a href="#" data-act="home" class="active">Cảnh</a>
      <a href="#" data-act="door">Cửa</a>
      <a href="#" data-act="tree">Cây</a>
      <a href="#" data-act="letter">Thư</a>
      <a href="#" data-act="photos">Ảnh</a>
    </nav>

    <div class="right">
      <button class="btn btnPrimary" id="btnStart">Start</button>
      <button class="btn" id="btnReset">Reset</button>
    </div>
  </header>

  <!-- CONTROL PANEL -->
  <div class="panel">
    <h3>Điều khiển (manual)</h3>
    <div class="hint">
      - Bấm <b>Start</b> để chạy hiệu ứng (tuyết/đèn).<br/>
      - Bấm <b>Cửa</b> / <b>Cây</b> để camera chuyển cảnh.<br/>
      - Bấm <b>Thư</b> / <b>Ảnh</b> để mở overlay (đọc rõ).<br/>
      - Bạn tự bật/tắt tuyết và nhấp nháy đèn.
    </div>

    <div class="row">
      <button class="btn btnPrimary" id="btnSnow">Bật tuyết</button>
      <button class="btn" id="btnTwinkle">Nhấp nháy đèn</button>
      <button class="btn" id="btnPulse">Pulse orb</button>
      <button class="btn" id="btnShake">Shake cam</button>
    </div>

    <label class="tog">
      <input type="checkbox" id="chkBloom" checked />
      Bloom (ánh sáng cinematic)
    </label>

    <div class="mono" id="stat">Status: idle</div>
  </div>

  <div class="toast" id="toast"></div>

  <!-- LETTER OVERLAY -->
  <div class="overlay" id="ovLetter" aria-hidden="true">
    <div class="card">
      <div class="cardHead">
        <b>Thư</b>
        <button class="xbtn" data-close="ovLetter">✕</button>
      </div>
      <div class="cardBody">
        <div class="letter" id="letterText">
          <p>
            Em à,<br/><br/>
            Cảm ơn em vì đã đến bên anh, theo cách rất nhẹ nhưng lại làm mọi thứ trong anh đổi khác.
            Có những ngày anh vụng về, có lúc anh chưa kịp hiểu hết cảm xúc của em,
            nhưng anh muốn em biết một điều rất rõ: <b>anh trân trọng em</b> và anh thật lòng muốn đi cùng em lâu dài.
          </p>
          <p>
            Anh hứa sẽ cố gắng để mỗi lần em nghĩ về anh, em sẽ thấy <b>yên tâm</b>,
            thấy được lắng nghe, và thấy được yêu thương đúng nghĩa.
          </p>
          <p>
            Nếu có lúc em thấy thế giới hơi nặng, em có thể dựa vào anh một chút.
            Anh không hứa sẽ làm được mọi thứ, nhưng anh hứa sẽ <b>ở đây</b> —
            bình tĩnh, kiên nhẫn, và chọn em mỗi ngày.
          </p>
          <p class="sig">— Yêu em rất nhiều. (Từ anh)</p>
        </div>
      </div>
    </div>
  </div>

  <!-- PHOTOS OVERLAY -->
  <div class="overlay" id="ovPhotos" aria-hidden="true">
    <div class="card">
      <div class="cardHead">
        <b>Ảnh</b>
        <button class="xbtn" data-close="ovPhotos">✕</button>
      </div>
      <div class="cardBody">
        <div class="gallery">
          <div class="shot" data-open="coay_1.jpg"><img src="coay_1.jpg" alt="Ảnh 1" loading="lazy"></div>
          <div class="shot" data-open="coay_2.jpg"><img src="coay_2.jpg" alt="Ảnh 2" loading="lazy"></div>
          <div class="shot" data-open="coay_3.jpg"><img src="coay_3.jpg" alt="Ảnh 3" loading="lazy"></div>
        </div>
        <p style="margin:10px 2px 0; color:rgba(245,247,255,.60); font-size:12.5px; line-height:1.5;">
          Nhấn vào ảnh để phóng to. Nếu ảnh không hiện: kiểm tra tên file đúng <b>coay_1.jpg / coay_2.jpg / coay_3.jpg</b> (chữ thường) và nằm cùng thư mục index.html.
        </p>
      </div>
    </div>
  </div>

  <!-- IMAGE LIGHTBOX -->
  <div class="overlay" id="ovLightbox" aria-hidden="true">
    <div class="card">
      <div class="cardHead">
        <b>Ảnh phóng to</b>
        <button class="xbtn" data-close="ovLightbox">✕</button>
      </div>
      <img class="lightboxImg" id="lbImg" alt="Ảnh phóng to">
    </div>
  </div>

  <script type="module">
    import * as THREE from "three";
    import { EffectComposer } from "three/addons/postprocessing/EffectComposer.js";
    import { RenderPass } from "three/addons/postprocessing/RenderPass.js";
    import { UnrealBloomPass } from "three/addons/postprocessing/UnrealBloomPass.js";

    /* ---------- Helpers ---------- */
    const $ = (id)=>document.getElementById(id);
    const stat = $("stat");
    const toast = $("toast");
    function setStat(t){ stat.textContent = "Status: " + t; }
    function popToast(msg){
      toast.textContent = msg;
      toast.classList.add("on");
      clearTimeout(popToast._t);
      popToast._t = setTimeout(()=>toast.classList.remove("on"), 1800);
    }

    /* ---------- Three Scene ---------- */
    const app = $("app");
    const renderer = new THREE.WebGLRenderer({ antialias:true, alpha:false });
    renderer.setPixelRatio(Math.min(devicePixelRatio, 2));
    renderer.setSize(innerWidth, innerHeight);
    renderer.setClearColor(0x070914, 1);
    app.appendChild(renderer.domElement);

    const scene = new THREE.Scene();
    scene.fog = new THREE.Fog(0x070914, 8, 34);

    const camera = new THREE.PerspectiveCamera(55, innerWidth/innerHeight, 0.1, 220);
    camera.position.set(0, 3.6, 12);
    camera.lookAt(0, 2.1, 0);

    // Composer + Bloom
    const composer = new EffectComposer(renderer);
    composer.addPass(new RenderPass(scene, camera));
    const bloom = new UnrealBloomPass(new THREE.Vector2(innerWidth, innerHeight), 0.95, 0.35, 0.25);
    composer.addPass(bloom);

    // Lights
    scene.add(new THREE.AmbientLight(0xffffff, 0.25));
    const moon = new THREE.DirectionalLight(0xbfd8ff, 0.60);
    moon.position.set(-7, 10, 6);
    scene.add(moon);

    // Ground
    const ground = new THREE.Mesh(
      new THREE.PlaneGeometry(80, 60),
      new THREE.MeshStandardMaterial({ color: 0xdee2ea, roughness: 0.95, metalness: 0.0 })
    );
    ground.rotation.x = -Math.PI/2;
    ground.position.y = 0;
    scene.add(ground);

    // House group
    const house = new THREE.Group();
    scene.add(house);

    const base = new THREE.Mesh(
      new THREE.BoxGeometry(6, 4.2, 5),
      new THREE.MeshStandardMaterial({ color: 0x78462e, roughness: 0.95 })
    );
    base.position.set(0, 2.1, 0);
    house.add(base);

    const roof = new THREE.Mesh(
      new THREE.ConeGeometry(4.8, 2.2, 4),
      new THREE.MeshStandardMaterial({ color: 0x5b2a22, roughness: 0.95 })
    );
    roof.position.set(0, 5.1, 0);
    roof.rotation.y = Math.PI/4;
    house.add(roof);

    // Door anchor
    const doorAnchor = new THREE.Object3D();
    doorAnchor.position.set(0, 1.6, 2.45);
    house.add(doorAnchor);

    // Tree
    const tree = new THREE.Group();
    tree.position.set(-6, 0, 2);
    scene.add(tree);

    const trunk = new THREE.Mesh(
      new THREE.CylinderGeometry(0.25, 0.3, 1.2, 12),
      new THREE.MeshStandardMaterial({ color: 0x5a3c23, roughness: 0.95 })
    );
    trunk.position.set(0, 0.6, 0);
    tree.add(trunk);

    const foliage = new THREE.Mesh(
      new THREE.ConeGeometry(1.9, 3.8, 20),
      new THREE.MeshStandardMaterial({ color: 0x2a8b4a, roughness: 0.95 })
    );
    foliage.position.set(0, 2.8, 0);
    tree.add(foliage);

    const treeAnchor = new THREE.Object3D();
    treeAnchor.position.set(-6, 2.2, 2);
    scene.add(treeAnchor);

    // Roof lights (bulbs)
    const bulbs = new THREE.Group();
    house.add(bulbs);

    const bulbGeo = new THREE.SphereGeometry(0.08, 12, 12);
    const bulbMats = Array.from({length: 14}, (_,i)=> new THREE.MeshStandardMaterial({
      color: 0xffffff,
      emissive: new THREE.Color().setHSL((i*0.11)%1, 0.8, 0.55),
      emissiveIntensity: 1.1,
      roughness: 0.3,
      metalness: 0.0
    }));

    for(let i=0;i<14;i++){
      const b = new THREE.Mesh(bulbGeo, bulbMats[i]);
      const x = -2.6 + i*0.4;
      const y = 4.35 + Math.sin(i*0.45)*0.08;
      const z = 2.4 - Math.abs(Math.sin(i*0.25))*0.55;
      b.position.set(x, y, z);
      bulbs.add(b);
    }

    // Orb
    const orb = new THREE.Mesh(
      new THREE.SphereGeometry(0.22, 32, 32),
      new THREE.MeshStandardMaterial({
        color: 0xffffff,
        emissive: 0xffe5b8,
        emissiveIntensity: 2.6,
        roughness: 0.2,
        metalness: 0.0
      })
    );
    orb.position.set(3.0, 4.8, 3.0);
    scene.add(orb);

    // Snow (Points)
    const snowCount = 1800;
    const snowGeo = new THREE.BufferGeometry();
    const snowPos = new Float32Array(snowCount * 3);
    const snowVel = new Float32Array(snowCount * 3);
    function resetSnow(i){
      snowPos[i*3+0] = (Math.random()*2-1)*22;
      snowPos[i*3+1] = Math.random()*14 + 3;
      snowPos[i*3+2] = (Math.random()*2-1)*18;
      snowVel[i*3+0] = (Math.random()*2-1)*0.10;
      snowVel[i*3+1] = -(0.8 + Math.random()*1.8);
      snowVel[i*3+2] = (Math.random()*2-1)*0.10;
    }
    for(let i=0;i<snowCount;i++) resetSnow(i);
    snowGeo.setAttribute("position", new THREE.BufferAttribute(snowPos, 3));
    const snowMat = new THREE.PointsMaterial({ color: 0xfafaff, size: 0.03, transparent:true, opacity: 0.9 });
    const snow = new THREE.Points(snowGeo, snowMat);
    scene.add(snow);

    /* ---------- Manual control states ---------- */
    const camBasePos  = new THREE.Vector3(0, 3.6, 12);
    const camBaseLook = new THREE.Vector3(0, 2.1, 0);

    function getDoorCam(){
      const p = doorAnchor.getWorldPosition(new THREE.Vector3());
      return {
        pos: p.clone().add(new THREE.Vector3(0, 1.4, 2.6)),
        look: p.clone().add(new THREE.Vector3(0, 0.4, 0))
      };
    }
    function getTreeCam(){
      const p = treeAnchor.getWorldPosition(new THREE.Vector3());
      return {
        pos: p.clone().add(new THREE.Vector3(0.5, 1.6, 4.3)),
        look: p.clone().add(new THREE.Vector3(0, 0.4, 0))
      };
    }

    let started = false;
    let snowOn = false;
    let twinkleOn = false;
    let pulseUntil = 0;
    let shakeUntil = 0;

    let targetPos = camBasePos.clone();
    let targetLook = camBaseLook.clone();

    /* ---------- UI Actions ---------- */
    const btnStart = $("btnStart");
    const btnReset = $("btnReset");
    const btnSnow = $("btnSnow");
    const btnTwinkle = $("btnTwinkle");
    const btnPulse = $("btnPulse");
    const btnShake = $("btnShake");
    const chkBloom = $("chkBloom");

    btnStart.addEventListener("click", ()=>{
      started = true;
      snowOn = true;
      btnSnow.textContent = "Tắt tuyết";
      setStat("running (manual controls)");
      popToast("Đã Start. Bạn tự điều khiển bằng nút.");
    });

    btnReset.addEventListener("click", ()=>{
      targetPos.copy(camBasePos);
      targetLook.copy(camBaseLook);
      twinkleOn = false;
      snowOn = started ? true : false;
      btnTwinkle.textContent = "Nhấp nháy đèn";
      btnSnow.textContent = snowOn ? "Tắt tuyết" : "Bật tuyết";
      popToast("Reset camera & hiệu ứng.");
    });

    btnSnow.addEventListener("click", ()=>{
      if(!started){ popToast("Hãy bấm Start trước."); return; }
      snowOn = !snowOn;
      btnSnow.textContent = snowOn ? "Tắt tuyết" : "Bật tuyết";
      popToast(snowOn ? "Đã bật tuyết." : "Đã tắt tuyết.");
    });

    btnTwinkle.addEventListener("click", ()=>{
      if(!started){ popToast("Hãy bấm Start trước."); return; }
      twinkleOn = !twinkleOn;
      btnTwinkle.textContent = twinkleOn ? "Tắt nhấp nháy" : "Nhấp nháy đèn";
      popToast(twinkleOn ? "Đèn đang nhấp nháy." : "Đèn ổn định.");
    });

    btnPulse.addEventListener("click", ()=>{
      if(!started){ popToast("Hãy bấm Start trước."); return; }
      pulseUntil = performance.now() + 1400;
      popToast("Pulse orb.");
    });

    btnShake.addEventListener("click", ()=>{
      if(!started){ popToast("Hãy bấm Start trước."); return; }
      shakeUntil = performance.now() + 240;
      popToast("Shake camera.");
    });

    chkBloom.addEventListener("change", ()=>{
      bloom.strength = chkBloom.checked ? 0.95 : 0.0;
      popToast(chkBloom.checked ? "Bloom ON" : "Bloom OFF");
    });

    // Nav link actions
    const links = Array.from(document.querySelectorAll("#links a"));
    function setActive(act){
      links.forEach(a=>a.classList.toggle("active", a.dataset.act === act));
    }
    links.forEach(a=>{
      a.addEventListener("click", (e)=>{
        e.preventDefault();
        const act = a.dataset.act;
        setActive(act);

        if(act === "home"){
          targetPos.copy(camBasePos);
          targetLook.copy(camBaseLook);
          popToast("Về cảnh chính.");
        }
        if(act === "door"){
          const d = getDoorCam();
          targetPos.copy(d.pos);
          targetLook.copy(d.look);
          popToast("Zoom vào cửa.");
        }
        if(act === "tree"){
          const d = getTreeCam();
          targetPos.copy(d.pos);
          targetLook.copy(d.look);
          popToast("Nhìn về cây.");
        }
        if(act === "letter"){
          openOverlay("ovLetter");
        }
        if(act === "photos"){
          openOverlay("ovPhotos");
        }
      });
    });

    /* ---------- Overlay logic ---------- */
    function openOverlay(id){
      const el = $(id);
      el.classList.add("on");
      el.setAttribute("aria-hidden","false");
    }
    function closeOverlay(id){
      const el = $(id);
      el.classList.remove("on");
      el.setAttribute("aria-hidden","true");
    }
    document.querySelectorAll("[data-close]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        closeOverlay(btn.getAttribute("data-close"));
      });
    });
    // click outside card to close
    ["ovLetter","ovPhotos","ovLightbox"].forEach(id=>{
      $(id).addEventListener("click", (e)=>{ if(e.target.id === id) closeOverlay(id); });
    });
    document.addEventListener("keydown", (e)=>{
      if(e.key === "Escape"){
        closeOverlay("ovLetter");
        closeOverlay("ovPhotos");
        closeOverlay("ovLightbox");
      }
    });

    // Photo lightbox
    const lbImg = $("lbImg");
    document.querySelectorAll("[data-open]").forEach(box=>{
      box.addEventListener("click", ()=>{
        const src = box.getAttribute("data-open");
        lbImg.src = src;
        openOverlay("ovLightbox");
      });
    });

    /* ---------- Animation Loop ---------- */
    const clock = new THREE.Clock();

    function animate(){
      requestAnimationFrame(animate);
      const dt = clock.getDelta();
      const t = clock.getElapsedTime();
      const now = performance.now();

      // Snow update (only when started & snowOn)
      snow.visible = started && snowOn;
      if(snow.visible){
        const pos = snowGeo.attributes.position.array;
        for(let i=0;i<snowCount;i++){
          pos[i*3+0] += snowVel[i*3+0]*dt;
          pos[i*3+1] += snowVel[i*3+1]*dt;
          pos[i*3+2] += snowVel[i*3+2]*dt;

          if(pos[i*3+1] < 0.2) resetSnow(i);
        }
        snowGeo.attributes.position.needsUpdate = true;
      }

      // Lights (manual twinkle)
      bulbs.children.forEach((mesh, i)=>{
        const mat = mesh.material;
        if(!started){
          mat.emissiveIntensity = 1.0;
          return;
        }
        if(twinkleOn){
          const puls = 0.55 + 0.45*Math.sin(t*2.2 + i*0.7);
          mat.emissiveIntensity = 1.2 + 1.2*puls;
        } else {
          mat.emissiveIntensity = 1.3;
        }
      });

      // Orb movement (subtle)
      if(started){
        orb.position.set(
          3.0 + 0.35*Math.sin(t*1.2),
          4.8 + 0.25*Math.sin(t*1.7),
          3.0
        );
      }

      // Orb pulse
      if(now < pulseUntil){
        const p = 0.6 + 0.4*Math.sin(t*12);
        orb.material.emissiveIntensity = 3.2 + 2.0*p;
        if(chkBloom.checked) bloom.strength = 1.05;
      } else {
        orb.material.emissiveIntensity = started ? 2.6 : 2.0;
        bloom.strength = chkBloom.checked ? 0.95 : 0.0;
      }

      // Camera smooth follow
      camera.position.lerp(targetPos, 1 - Math.pow(0.002, dt));
      const dir = new THREE.Vector3();
      camera.getWorldDirection(dir);
      const currLook = camera.position.clone().add(dir);
      const nextLook = currLook.lerp(targetLook, 1 - Math.pow(0.002, dt));
      camera.lookAt(nextLook);

      // Camera shake
      if(now < shakeUntil){
        const amp = 0.06;
        camera.position.x += (Math.random()*2-1)*amp;
        camera.position.y += (Math.random()*2-1)*amp;
        camera.position.z += (Math.random()*2-1)*amp;
      }

      composer.render();
    }
    animate();

    addEventListener("resize", ()=>{
      renderer.setSize(innerWidth, innerHeight);
      camera.aspect = innerWidth/innerHeight;
      camera.updateProjectionMatrix();
      composer.setSize(innerWidth, innerHeight);
      bloom.setSize(innerWidth, innerHeight);
    });

    setStat("idle (bấm Start để chạy)");
  </script>
</body>
</html>
